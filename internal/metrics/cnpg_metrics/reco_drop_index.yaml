query: "with q_database_size as (\n  select pg_database_size(current_database()) as\
  \ database_size_b\n),\nr as (select /* pgwatch_generated */\n    indexrelid::regclass::text\
  \ as object_name\n    from pg_stat_user_indexes\n    join pg_index using (indexrelid)\n\
  \    join q_database_size on true\n    where idx_scan = 0\n    and ((pg_relation_size(indexrelid)::numeric\
  \ / database_size_b) > 0.005 /* 0.5% DB size threshold */\n      or not indisvalid)\n\
  \    and not indisprimary\n    and not indisreplident\n    and not schemaname like\
  \ '_timescaledb%'),\nlimited_r as (select * from r limit 25),\nrr as (select\n \
  \   (extract(epoch from now()) * 1e9)::int8 as epoch_ns,\n    'drop_index'::text\
  \ as tag_reco_topic,\n    string_agg(object_name, ',') as tag_object_name,\n   \
  \ 'drop unused or invalid indexes to improve performance'::text as recommendation,\n\
  \    'Make sure to also check replica pg_stat_user_indexes.idx_scan count if using\
  \ them for queries'::text as extra_info\n    from limited_r),\nlast_reco(s) as (\n\
  \    select case when count(*) > 25 then format(' and found %s more...', count(*)-25)\
  \ end from r),\ntotal_count as (\n    select count(*) as total from r)\nselect \n\
  \    epoch_ns,\n    tag_reco_topic,\n    concat(tag_object_name, s) as tag_object_name,\n\
  \    recommendation,\n    extra_info,\n    total as total_recommendations\nfrom\
  \ rr, last_reco, total_count\nwhere tag_object_name > '';\n"
metrics: []
init_sql: CREATE EXTENSION IF NOT EXISTS pg_qualstats;
