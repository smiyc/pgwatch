query: "select /* pgwatch_generated */\n  (extract(epoch from now()) * 1e9)::int8\
  \ as epoch_ns,\n  retcode,\n  backup_age_seconds,\n  message\nfrom\n  get_backup_age_pgbackrest()\n"
metrics: []
init_sql: "CREATE EXTENSION IF NOT EXISTS plpython3u;\n\nCREATE OR REPLACE FUNCTION\
  \ get_backup_age_pgbackrest(OUT retcode int, OUT backup_age_seconds int, OUT message\
  \ text) AS\n$$\nimport time\nimport json\nimport subprocess\n\nPGBACKREST_TIMEOUT\
  \ = 30\n\ndef error(message, returncode=1):\n  return returncode, 1000000, 'Not\
  \ OK. '+message\n\npgbackrest_cmd=[\"pgbackrest\", \"--output=json\", \"info\"]\n\
  \ntry:\n    p = subprocess.Popen(pgbackrest_cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE,\
  \ encoding='utf-8')\n    stdout, stderr = p.communicate(timeout=PGBACKREST_TIMEOUT)\n\
  except OSError as e:\n    return error('Failed to execute pgbackrest: {}'.format(e))\n\
  except subprocess.TimeoutExpired:\n    p.terminate()\n    try:\n        p.wait(0.5)\n\
  \    except subprocess.TimeoutExpired:\n        p.kill()\n    return error('pgbackrest\
  \ failed to respond in {} seconds'.format(PGBACKREST_TIMEOUT))\n\nif p.returncode\
  \ != 0:\n    return error('Failed on \"pgbackrest info\" call', returncode=p.returncode)\n\
  \ntry:\n    data = json.loads(stdout)\n    backup_age_seconds = int(time.time())\
  \ - data[0]['backup'][-1]['timestamp']['stop']\n    return 0, backup_age_seconds,\
  \ 'OK. Last backup age in seconds: {}'.format(backup_age_seconds)\nexcept (json.JSONDecodeError,\
  \ KeyError) :\n    return error('Failed to parse pgbackrest output')\n$$ LANGUAGE\
  \ plpython3u VOLATILE;\n\nALTER FUNCTION get_backup_age_pgbackrest() SET statement_timeout\
  \ TO '30s';\n\nGRANT EXECUTE ON FUNCTION get_backup_age_pgbackrest() TO pgwatch;\n\
  \nCOMMENT ON FUNCTION get_backup_age_pgbackrest() is 'created for pgwatch';"
