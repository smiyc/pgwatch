query: "/* accessing pgstattuple_approx directly requires superuser or pg_stat_scan_tables/pg_monitor\
  \ builtin roles or\n   execute grant on pgstattuple_approx(regclass)\n*/\nwith table_bloat_approx\
  \ as (\n    select\n        avg(approx_free_percent)::double precision as approx_free_percent,\n\
  \        sum(approx_free_space)::double precision as approx_free_space,\n      \
  \  avg(dead_tuple_percent)::double precision as dead_tuple_percent,\n        sum(dead_tuple_len)::double\
  \ precision as dead_tuple_len\n    from\n        pg_class c\n            join\n\
  \        pg_namespace n on n.oid = c.relnamespace\n            join lateral pgstattuple_approx(c.oid)\
  \ on (c.oid not in (select relation from pg_locks where mode = 'AccessExclusiveLock'))\
  \  -- skip locked tables\n    where\n        relkind in ('r', 'm')\n        and\
  \ c.relpages >= 128 -- tables >1mb\n        and not n.nspname != 'information_schema'\n\
  )\nselect /* pgwatch_generated */\n    (extract(epoch from now()) * 1e9)::int8 as\
  \ epoch_ns,\n    approx_free_percent,\n    approx_free_space as approx_free_space_b,\n\
  \    dead_tuple_percent,\n    dead_tuple_len as dead_tuple_len_b\nfrom\n    table_bloat_approx\n\
  where\n     approx_free_space > 0"
metrics: []
init_sql: create extension if not exists pgstattuple;
