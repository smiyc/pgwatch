query: "WITH q_stat_tables AS (\n  SELECT * FROM pg_stat_user_tables t\n  JOIN pg_class\
  \ c ON c.oid = t.relid\n  WHERE NOT schemaname LIKE E'pg\\\\_temp%'\n  AND c.relpages\
  \ > (1e7 / 8)    -- >10MB\n),\nq_stat_activity AS (\n  SELECT * FROM pg_stat_activity\n\
  \  WHERE datname = current_database() AND pid != pg_backend_pid()\n)\nselect /*\
  \ pgwatch_generated */\n  (extract(epoch from now()) * 1e9)::int8 as epoch_ns,\n\
  \  case\n    when pg_is_in_recovery() = false then\n      pg_wal_lsn_diff(pg_current_wal_lsn(),\
  \ '0/0')::int8\n    else\n      pg_wal_lsn_diff(pg_last_wal_replay_lsn(), '0/0')::int8\n\
  \    end as wal_location_b,\n  numbackends - 1 as numbackends,\n  (select count(*)\
  \ from q_stat_activity where state in ('active', 'idle in transaction')) AS active_backends,\n\
  \  (select count(*) from q_stat_activity where wait_event_type in ('LWLock', 'Lock',\
  \ 'BufferPin')) AS blocked_backends,\n  (select round(extract(epoch from now())\
  \ - extract(epoch from (select xact_start from q_stat_activity\n  where datid =\
  \ d.datid and not query like 'autovacuum:%' order by xact_start limit 1))))::int\
  \ AS kpi_oldest_tx_s,\n  xact_commit + xact_rollback AS tps,\n  xact_commit,\n \
  \ xact_rollback,\n  blks_read,\n  blks_hit,\n  temp_bytes,\n  (select sum(seq_scan)\
  \ from q_stat_tables)::int8 AS seq_scans_on_tbls_gt_10mb,\n  tup_inserted,\n  tup_updated,\n\
  \  tup_deleted,\n  (select sum(calls) from pg_stat_user_functions where not schemaname\
  \ like any(array[E'pg\\\\_%', 'information_schema']))::int8 AS sproc_calls,\n  blk_read_time,\n\
  \  blk_write_time,\n  deadlocks,\n  case when pg_is_in_recovery() then 1 else 0\
  \ end as in_recovery_int,\n  extract(epoch from (now() - pg_postmaster_start_time()))::int8\
  \ as postmaster_uptime_s  \nFROM\n  pg_stat_database d\nWHERE\n  datname = current_database()\n"
metrics:
- name: numbackends
  type: gauge
- name: active_backends
  type: gauge
- name: blocked_backends
  type: gauge
- name: kpi_oldest_tx_s
  type: gauge
