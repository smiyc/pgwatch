query: "WITH q_bloat AS (\n    SELECT\n                quote_ident(schemaname)||'.'||quote_ident(tblname)\
  \ as full_table_name,\n                bloat_ratio as approx_bloat_percent,\n  \
  \              bloat_size as approx_bloat_bytes,\n                fillfactor\n \
  \   FROM (\n\n/* WARNING: executed with a non-superuser role, the query inspect\
  \ only tables you are granted to read.\n* This query is compatible with PostgreSQL\
  \ 9.0 and more\n*/\n             SELECT current_database(),\n                  \
  \  schemaname,\n                    tblname,\n                    bs * tblpages\
  \                  AS real_size,\n                    (tblpages - est_tblpages)\
  \ * bs AS extra_size,\n                    CASE\n                        WHEN tblpages\
  \ - est_tblpages > 0\n                            THEN 100 * (tblpages - est_tblpages)\
  \ / tblpages::float\n                        ELSE 0\n                        END\
  \                        AS extra_ratio,\n                    fillfactor,\n    \
  \                CASE\n                        WHEN tblpages - est_tblpages_ff >\
  \ 0\n                            THEN (tblpages - est_tblpages_ff) * bs\n      \
  \                  ELSE 0\n                        END                        AS\
  \ bloat_size,\n                    CASE\n                        WHEN tblpages -\
  \ est_tblpages_ff > 0\n                            THEN 100 * (tblpages - est_tblpages_ff)\
  \ / tblpages::float\n                        ELSE 0\n                        END\
  \                        AS bloat_ratio,\n                    is_na\n          \
  \          -- , (pst).free_percent + (pst).dead_tuple_percent AS real_frag\n   \
  \          FROM (\n                      SELECT ceil(reltuples / ((bs - page_hdr)\
  \ / tpl_size)) + ceil(toasttuples / 4)                      AS est_tblpages,\n \
  \                            ceil(reltuples / ((bs - page_hdr) * fillfactor / (tpl_size\
  \ * 100))) +\n                             ceil(toasttuples / 4)               \
  \                                                        AS est_tblpages_ff,\n \
  \                            tblpages,\n                             fillfactor,\n\
  \                             bs,\n                             tblid,\n       \
  \                      schemaname,\n                             tblname,\n    \
  \                         heappages,\n                             toastpages,\n\
  \                             is_na\n                             -- , stattuple.pgstattuple(tblid)\
  \ AS pst\n                      FROM (\n                               SELECT (4\
  \ + tpl_hdr_size + tpl_data_size + (2 * ma)\n                                  \
  \ - CASE WHEN tpl_hdr_size % ma = 0 THEN ma ELSE tpl_hdr_size % ma END\n       \
  \                            - CASE\n                                         WHEN\
  \ ceil(tpl_data_size)::int % ma = 0 THEN ma\n                                  \
  \       ELSE ceil(tpl_data_size)::int % ma END\n                               \
  \           )                    AS tpl_size,\n                                \
  \      bs - page_hdr            AS size_per_block,\n                           \
  \           (heappages + toastpages) AS tblpages,\n                            \
  \          heappages,\n                                      toastpages,\n     \
  \                                 reltuples,\n                                 \
  \     toasttuples,\n                                      bs,\n                \
  \                      page_hdr,\n                                      tblid,\n\
  \                                      schemaname,\n                           \
  \           tblname,\n                                      fillfactor,\n      \
  \                                is_na\n                               FROM (\n\
  \                                        SELECT tbl.oid                        \
  \                                   AS tblid,\n                                \
  \               ns.nspname                                                     \
  \   AS schemaname,\n                                               tbl.relname \
  \                                                      AS tblname,\n           \
  \                                    tbl.reltuples,\n                          \
  \                     tbl.relpages                                             \
  \         AS heappages,\n                                               coalesce(toast.relpages,\
  \ 0)                                       AS toastpages,\n                    \
  \                           coalesce(toast.reltuples, 0)                       \
  \               AS toasttuples,\n                                              \
  \ coalesce(substring(\n                                                        \
  \        array_to_string(tbl.reloptions, ' ')\n                                \
  \                                FROM 'fillfactor=([0-9]+)')::smallint,\n      \
  \                                                  100)                        \
  \                             AS fillfactor,\n                                 \
  \              current_setting('block_size')::numeric                          \
  \  AS bs,\n                                               CASE\n               \
  \                                    WHEN version() ~ 'mingw32' OR version() ~ '64-bit|x86_64|ppc64|ia64|amd64'\n\
  \                                                       THEN 8\n               \
  \                                    ELSE 4 END                                \
  \                    AS ma,\n                                               24 \
  \                                                               AS page_hdr,\n \
  \                                              23 + CASE\n                     \
  \                                   WHEN MAX(coalesce(null_frac, 0)) > 0 THEN (7\
  \ + count(*)) / 8\n                                                        ELSE\
  \ 0::int END\n                                                   +\n           \
  \                                    CASE WHEN tbl.relhasoids THEN 4 ELSE 0 END\
  \                        AS tpl_hdr_size,\n                                    \
  \           sum((1 - coalesce(s.null_frac, 0)) * coalesce(s.avg_width, 1024)) AS\
  \ tpl_data_size,\n                                               bool_or(att.atttypid\
  \ = 'pg_catalog.name'::regtype)\n                                              \
  \     OR count(att.attname) <> count(s.attname)                     AS is_na\n \
  \                                       FROM pg_attribute AS att\n             \
  \                                    JOIN pg_class AS tbl ON att.attrelid = tbl.oid\n\
  \                                                 JOIN pg_namespace AS ns ON ns.oid\
  \ = tbl.relnamespace\n                                                 LEFT JOIN\
  \ pg_stats AS s ON s.schemaname = ns.nspname\n                                 \
  \           AND s.tablename = tbl.relname AND s.inherited = false AND\n        \
  \                                                                    s.attname =\
  \ att.attname\n                                                 LEFT JOIN pg_class\
  \ AS toast ON tbl.reltoastrelid = toast.oid\n                                  \
  \      WHERE att.attnum > 0\n                                          AND NOT att.attisdropped\n\
  \                                          AND tbl.relkind IN ('r', 'm')\n     \
  \                                     AND ns.nspname != 'information_schema'\n \
  \                                       GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10,\
  \ tbl.relhasoids\n                                        ORDER BY 2, 3\n      \
  \                              ) AS s\n                           ) AS s2\n    \
  \              ) AS s3\n             -- WHERE NOT is_na\n         ) s4\n)\nselect\
  \ /* pgwatch_generated */\n    (extract(epoch from now()) * 1e9)::int8 as epoch_ns,\n\
  \    (select sum(approx_bloat_bytes) from q_bloat) as approx_table_bloat_b,\n  \
  \  ((select sum(approx_bloat_bytes) from q_bloat) * 100 / pg_database_size(current_database()))::int8\
  \ as approx_bloat_percentage\n"
metrics: []
init_sql: create extension if not exists pgstattuple;
